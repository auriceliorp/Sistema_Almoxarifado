{% extends 'base_simplificada.html' %}
{% block title %}Nova Saída de Materiais{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Nova Saída de Materiais</h2>

    <!-- Formulário de registro de saída -->
    <form method="post">
        <div class="row mb-3">
            <!-- Data do movimento -->
            <div class="col-md-3">
                <label for="data_movimento" class="form-label">Data do Movimento</label>
                <input type="date" class="form-control" name="data_movimento" required>
            </div>

            <!-- Número do documento (gerado automaticamente e não editável) -->
            <div class="col-md-3">
                <label for="numero_documento" class="form-label">Nº Documento</label>
                <input type="text" class="form-control" name="numero_documento" value="{{ numero_documento }}" readonly>
            </div>

            <!-- Solicitante (usuário selecionável) -->
            <div class="col-md-6">
                <label for="solicitante" class="form-label">Solicitante *</label>
                <select name="solicitante" class="form-select" required>
                    <option value="" disabled selected>Selecione o solicitante...</option>
                    {% for usuario in usuarios %}
                        <option value="{{ usuario.id }}">{{ usuario.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Campo para observações -->
        <div class="mb-3">
            <label for="observacao" class="form-label">Observação</label>
            <textarea class="form-control" name="observacao"></textarea>
        </div>

        <!-- Tabela com os itens -->
        <h5>Itens a dar saída</h5>
        <div id="itens-container">
            <div class="item-row row">
                <div class="col-md-4 mb-2">
                    <label>Item</label>
                    <select name="item_id[]" class="form-control item-select" required onchange="atualizarValor(this)">
                        <option value="">Selecione...</option>
                        {% for item in itens %}
                            <option value="{{ item.id }}" data-valor="{{ item.valor_unitario }}" data-estoque="{{ item.estoque_atual }}">
                                {{ item.nome }} (Estoque: {{ item.estoque_atual }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <label>Quantidade</label>
                    <input type="number" name="quantidade[]" class="form-control" min="1" required onchange="calcularTotal(this)">
                </div>
                <div class="col-md-2 mb-2">
                    <label>Valor Unitário</label>
                    <input type="number" step="0.01" name="valor_unitario[]" class="form-control valor-unitario" readonly>
                </div>
                <div class="col-md-2 mb-2">
                    <label>Total</label>
                    <input type="number" step="0.01" class="form-control valor-total" readonly>
                </div>
                <div class="col-md-2 d-flex align-items-end mb-2">
                    <button type="button" class="btn btn-danger" onclick="removerItem(this)">Remover</button>
                </div>
            </div>
        </div>

        <!-- Botões para adicionar novo item e salvar -->
        <button type="button" class="btn btn-secondary mt-3" onclick="adicionarItem()">Adicionar Item</button>
        <button type="submit" class="btn btn-success mt-3">Salvar Saída</button>
        <a href="{{ url_for('saida_bp.lista_saidas') }}" class="btn btn-outline-secondary mt-3">Cancelar</a>
    </form>
</div>

<!-- JavaScript para adicionar/remover linhas e calcular totais -->
<script>
function adicionarItem() {
    const container = document.getElementById('itens-container');
    const novaLinha = container.firstElementChild.cloneNode(true);
    novaLinha.querySelectorAll('input, select').forEach(el => el.value = '');
    container.appendChild(novaLinha);
}

function removerItem(botao) {
    const linha = botao.closest('.item-row');
    const container = document.getElementById('itens-container');
    if (container.childElementCount > 1) linha.remove();
}

function atualizarValor(select) {
    const option = select.options[select.selectedIndex];
    const valor = option.getAttribute('data-valor');
    const estoque = parseFloat(option.getAttribute('data-estoque'));
    const linha = select.closest('.item-row');
    const inputValor = linha.querySelector('.valor-unitario');
    const quantidade = linha.querySelector('[name="quantidade[]"]');

    inputValor.value = valor || 0;

    if (estoque <= 0) {
        alert("Atenção: Estoque indisponível para esse item!");
        select.classList.add('is-invalid');
    } else {
        select.classList.remove('is-invalid');
    }

    calcularTotal(quantidade);
}

function calcularTotal(inputQuantidade) {
    const linha = inputQuantidade.closest('.item-row');
    const valorUnitario = parseFloat(linha.querySelector('.valor-unitario').value) || 0;
    const quantidade = parseFloat(inputQuantidade.value) || 0;
    const total = linha.querySelector('.valor-total');
    total.value = (valorUnitario * quantidade).toFixed(2);
}
</script>
{% endblock %}
