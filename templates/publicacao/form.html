{% extends 'base_simplificada.html' %}
{% block title %}{{ 'Nova' if not publicacao else 'Editar' }} Publicação{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <h4 class="mb-4 text-center">{{ 'Cadastrar Nova' if not publicacao else 'Editar' }} Publicação</h4>
      <form method="POST">
        <div class="row g-3">
          
          <!-- Espécie e Contrato SAIC -->
          <div class="col-md-8">
            <label for="especie" class="form-label">Espécie *</label>
            <input type="text" class="form-control" id="especie" name="especie" 
                   value="{{ publicacao.especie if publicacao else '' }}" required>
          </div>
          <div class="col-md-4">
            <label for="contrato_saic" class="form-label">Contrato SAIC</label>
            <input type="text" class="form-control" id="contrato_saic" name="contrato_saic"
                   value="{{ publicacao.contrato_saic if publicacao else '' }}"
                   placeholder="Não Aplicável">
          </div>

          <!-- Objeto -->
          <div class="col-12">
            <label for="objeto" class="form-label">Objeto *</label>
            <textarea class="form-control" id="objeto" name="objeto" rows="3" required>{{ publicacao.objeto if publicacao else '' }}</textarea>
          </div>

          <!-- Modalidade e Fonte de Recursos -->
          <div class="col-md-6">
            <label for="modalidade_licitacao" class="form-label">Modalidade de Licitação</label>
            <select class="form-select" id="modalidade_licitacao" name="modalidade_licitacao">
              <option value="">Selecione... (Não se Aplica)</option>
              {% set modalidades = ['Pregão Eletrônico', 'Dispensa de Licitação', 
                                  'Inexigibilidade', 'Licitação Embrapa', 'Não se Aplica'] %}
              {% for mod in modalidades %}
                <option value="{{ mod }}" 
                        {{ 'selected' if publicacao and publicacao.modalidade_licitacao == mod }}>
                  {{ mod }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="fonte_recursos" class="form-label">Fonte de Recursos</label>
            <input type="text" class="form-control" id="fonte_recursos" name="fonte_recursos"
                   value="{{ publicacao.fonte_recursos if publicacao else '' }}"
                   placeholder="Não se Aplica">
          </div>

          <!-- Valor Global -->
          <div class="col-md-4">
            <label for="valor_global" class="form-label">Valor Global</label>
            <input type="text" class="form-control" id="valor_global" name="valor_global"
                   value="{{ publicacao.valor_global if publicacao else '' }}"
                   placeholder="Não Aplicável">
          </div>

          <!-- Vigência -->
          <div class="col-md-4">
            <label for="vigencia_inicio" class="form-label">Vigência Início</label>
            <input type="date" class="form-control" id="vigencia_inicio" name="vigencia_inicio"
                   value="{{ publicacao.vigencia_inicio.strftime('%Y-%m-%d') if publicacao and publicacao.vigencia_inicio else '' }}">
          </div>
          <div class="col-md-4">
            <label for="vigencia_fim" class="form-label">Vigência Fim</label>
            <input type="date" class="form-control" id="vigencia_fim" name="vigencia_fim"
                   value="{{ publicacao.vigencia_fim.strftime('%Y-%m-%d') if publicacao and publicacao.vigencia_fim else '' }}">
          </div>

          <!-- Data Assinatura -->
          <div class="col-md-4">
            <label for="data_assinatura" class="form-label">Data da Assinatura *</label>
            <input type="date" class="form-control" id="data_assinatura" name="data_assinatura"
                   value="{{ publicacao.data_assinatura.strftime('%Y-%m-%d') if publicacao else '' }}" required>
          </div>

          <!-- Partes Embrapa -->
          <div class="col-md-6">
            <label for="partes_embrapa" class="form-label">Partes Embrapa</label>
            <select class="form-select" id="partes_embrapa" name="partes_embrapa" multiple>
              {% for usuario in usuarios %}
                <option value="{{ usuario.id }}"
                        {{ 'selected' if publicacao and usuario in publicacao.partes_embrapa }}>
                  {{ usuario.nome }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Partes Fornecedor -->
          <div class="col-md-6">
            <label for="partes_fornecedor" class="form-label">Partes Fornecedor</label>
            <select class="form-select" id="partes_fornecedor" name="partes_fornecedor" multiple>
              {% for fornecedor in fornecedores %}
                <option value="{{ fornecedor.id }}"
                        {{ 'selected' if publicacao and fornecedor in publicacao.partes_fornecedor }}>
                  {{ fornecedor.nome }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Signatários Embrapa -->
          <div class="col-md-6">
            <label for="signatarios_embrapa" class="form-label">Signatários Embrapa</label>
            <select class="form-select" id="signatarios_embrapa" name="signatarios_embrapa" multiple>
              {% for usuario in usuarios %}
                <option value="{{ usuario.id }}"
                        {{ 'selected' if publicacao and usuario in publicacao.signatarios_embrapa }}>
                  {{ usuario.nome }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Signatários Externos -->
          <div class="col-md-6">
            <label for="signatarios_externos" class="form-label">Signatários Externos</label>
            <select class="form-select" id="signatarios_externos" name="signatarios_externos" multiple>
              {% for fornecedor in fornecedores %}
                <option value="{{ fornecedor.id }}"
                        {{ 'selected' if publicacao and fornecedor in publicacao.signatarios_externos }}>
                  {{ fornecedor.nome }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Botões -->
        <div class="mt-4 d-flex justify-content-end gap-2">
          <button type="submit" class="btn btn-success">Salvar</button>
          <a href="{{ url_for('publicacoes.listar') }}" class="btn btn-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Select2 para melhorar a experiência com selects múltiplos -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Inicializa Select2 para todos os selects múltiplos
    $('select[multiple]').select2({
      width: '100%',
      placeholder: 'Selecione...',
      allowClear: true
    });
  });
</script>
{% endblock %}
