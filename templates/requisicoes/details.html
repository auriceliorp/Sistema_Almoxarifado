{% extends "base.html" %}

{% block title %}Detalhes da Requisição {{ requisicao.id }} - Almoxarifado{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Requisição #{{ requisicao.id }}</h2>
    <a href="{{ url_for("main.listar_requisicoes") }}" class="btn btn-outline-secondary">Voltar para Lista</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        Informações da Requisição
    </div>
    <div class="card-body">
        <p><strong>Status:</strong>
            {% if requisicao.status == "PENDENTE" %}
                <span class="badge bg-warning text-dark">Pendente</span>
            {% elif requisicao.status == "APROVADA" %}
                <span class="badge bg-info text-dark">Aprovada</span>
            {% elif requisicao.status == "REJEITADA" %}
                <span class="badge bg-danger">Rejeitada</span>
            {% elif requisicao.status == "ATENDIDA_PARCIAL" %}
                <span class="badge bg-primary">Atendida Parcialmente</span>
            {% elif requisicao.status == "ATENDIDA_TOTAL" %}
                <span class="badge bg-success">Atendida Totalmente</span>
            {% elif requisicao.status == "CANCELADA" %}
                <span class="badge bg-secondary">Cancelada</span>
            {% else %}
                {{ requisicao.status }}
            {% endif %}
        </p>
        <p><strong>Solicitante:</strong> {{ requisicao.solicitante.nome if requisicao.solicitante else "N/A" }}</p>
        <p><strong>Data da Requisição:</strong> {{ requisicao.data_requisicao.strftime("%d/%m/%Y %H:%M") if requisicao.data_requisicao else "" }}</p>
        <p><strong>Observação do Solicitante:</strong> {{ requisicao.observacao_solicitante }}</p>
        {% if requisicao.aprovador %}
            <hr>
            <p><strong>Aprovador/Rejeitor:</strong> {{ requisicao.aprovador.nome }}</p>
            <p><strong>Data Aprovação/Rejeição:</strong> {{ requisicao.data_aprovacao.strftime("%d/%m/%Y %H:%M") if requisicao.data_aprovacao else "" }}</p>
            <p><strong>Observação do Aprovador:</strong> {{ requisicao.observacao_aprovador }}</p>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        Itens da Requisição
    </div>
    <div class="card-body">
        {% if requisicao.itens_requisicao.all() %}
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qtd. Solicitada</th>
                    <th>Qtd. Atendida</th>
                    {% if requisicao.status == "PENDENTE" %} {# TODO: Verificar permissão #}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item_req in requisicao.itens_requisicao %}
                <tr>
                    <td>{{ item_req.item.nome if item_req.item else "N/A" }}</td>
                    <td>{{ item_req.quantidade_solicitada }}</td>
                    <td>{{ item_req.quantidade_atendida }}</td>
                    {% if requisicao.status == "PENDENTE" %} {# TODO: Verificar permissão #}
                    <td>
                        <form action="{{ url_for("main.remover_item_requisicao", req_id=requisicao.id, item_req_id=item_req.id) }}" method="POST" class="d-inline" onsubmit="return confirm("Remover este item da requisição?");">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Remover</button>
                        </form>
                        {# TODO: Adicionar botão/modal para editar quantidade? #}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">Nenhum item adicionado a esta requisição ainda.</p>
        {% endif %}

        {# Formulário para adicionar item (se pendente e permitido) #}
        {% if requisicao.status == "PENDENTE" %} {# TODO: Verificar permissão #}
        <hr>
        <h5>Adicionar Item</h5>
        <form method="POST" action="{{ url_for("main.adicionar_item_requisicao", id=requisicao.id) }}" class="row g-3 align-items-end">
            <div class="col-md-6">
                <label for="item_id" class="form-label">Item</label>
                <select class="form-select form-select-sm" id="item_id" name="item_id" required>
                    <option value="" selected disabled>Selecione...</option>
                    {% for item in itens_ativos %}
                        <option value="{{ item.id }}">{{ item.nome }} (Saldo: {{ item.saldo_atual }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="quantidade_solicitada" class="form-label">Quantidade</label>
                <input type="number" class="form-control form-control-sm" id="quantidade_solicitada" name="quantidade_solicitada" required min="1">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-sm btn-success">Adicionar Item</button>
            </div>
        </form>
        {% endif %}
    </div>
</div>

{# Ações do Administrador #}
{# TODO: Verificar permissão (Admin) #}
<div class="card mb-4">
    <div class="card-header">
        Ações do Administrador
    </div>
    <div class="card-body">
        {% if requisicao.status == "PENDENTE" %}
            <div class="row g-3">
                <div class="col-md-6">
                    <form method="POST" action="{{ url_for("main.aprovar_requisicao", id=requisicao.id) }}">
                        <div class="mb-2">
                            <label for="obs_aprovar" class="form-label">Observação (Opcional ao aprovar):</label>
                            <input type="text" class="form-control form-control-sm" id="obs_aprovar" name="observacao_aprovador">
                        </div>
                        <button type="submit" class="btn btn-success">Aprovar Requisição</button>
                    </form>
                </div>
                <div class="col-md-6">
                    <form method="POST" action="{{ url_for("main.rejeitar_requisicao", id=requisicao.id) }}">
                        <div class="mb-2">
                            <label for="obs_rejeitar" class="form-label">Observação (Obrigatória ao rejeitar):</label>
                            <input type="text" class="form-control form-control-sm" id="obs_rejeitar" name="observacao_aprovador" required>
                        </div>
                        <button type="submit" class="btn btn-danger">Rejeitar Requisição</button>
                    </form>
                </div>
            </div>
        {% elif requisicao.status == "APROVADA" or requisicao.status == "ATENDIDA_PARCIAL" %}
            <form method="POST" action="{{ url_for("main.atender_requisicao", id=requisicao.id) }}">
                <p>Esta requisição está aprovada. Clique abaixo para tentar atender os itens pendentes com base no estoque atual.</p>
                <button type="submit" class="btn btn-primary">Atender Itens Pendentes</button>
            </form>
        {% else %}
            <p class="text-muted">Nenhuma ação administrativa disponível para o status atual ({{ requisicao.status }}).</p>
        {% endif %}
    </div>
</div>

{% endblock %}

