{% extends "base.html" %}

{% block title %}Relatório Mensal por ND - Almoxarifado{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Relatório Mensal por Natureza de Despesa (ND)</h2>
    {# TODO: Adicionar botão para exportar (CSV/PDF)? #}
</div>

{# Formulário para selecionar o mês/ano #}
<form method="GET" action="{{ url_for("main.relatorio_mensal_nd") }}" class="row g-3 mb-4 align-items-end">
    <div class="col-auto">
        <label for="mes_ano" class="form-label">Mês/Ano (YYYY-MM):</label>
        <input type="month" class="form-control" id="mes_ano" name="mes_ano" value="{{ mes_ano }}" required>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Gerar Relatório</button>
    </div>
</form>

{% if relatorio %}
<p class="text-muted">Exibindo relatório para o mês: <strong>{{ mes_ano }}</strong></p>

{% for nd_data in relatorio %}
<div class="card mb-3">
    <div class="card-header">
        <strong>ND: {{ nd_data.nd.codigo }} - {{ nd_data.nd.descricao }}</strong>
    </div>
    <div class="card-body">
        <div class="row mb-2">
            <div class="col">Saldo Inicial: {{ nd_data.saldo_inicial }}</div>
            <div class="col text-success">Total Entradas: +{{ nd_data.total_entradas }}</div>
            <div class="col text-danger">Total Saídas: -{{ nd_data.total_saidas }}</div>
            <div class="col fw-bold">Saldo Final: {{ nd_data.saldo_final }}</div>
        </div>

        {% if nd_data.itens %}
        <details>
            <summary>Detalhes por Item</summary>
            <table class="table table-sm table-bordered mt-2">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Saldo Inicial</th>
                        <th>Entradas</th>
                        <th>Saídas</th>
                        <th>Saldo Final</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_detalhe in nd_data.itens %}
                    <tr>
                        <td>{{ item_detalhe.item.nome }}</td>
                        <td>{{ item_detalhe.saldo_inicial }}</td>
                        <td>{{ item_detalhe.entradas }}</td>
                        <td>{{ item_detalhe.saidas }}</td>
                        <td>{{ item_detalhe.saldo_final }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </details>
        {% endif %}
    </div>
</div>
{% endfor %}

{% elif mes_ano %}
<div class="alert alert-info" role="alert">
    Nenhum dado encontrado para o mês {{ mes_ano }}.
</div>
{% endif %}

{% endblock %}

