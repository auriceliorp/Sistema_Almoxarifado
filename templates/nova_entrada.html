{% extends 'base_simplificada.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Nova Entrada de Material</h2>
  <form method="post">
    <!-- Campos principais da entrada -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="data_movimento" class="form-label">Data do Movimento *</label>
        <input type="date" class="form-control" id="data_movimento" name="data_movimento" required>
      </div>
      <div class="col-md-4">
        <label for="data_nota_fiscal" class="form-label">Data da Nota Fiscal *</label>
        <input type="date" class="form-control" id="data_nota_fiscal" name="data_nota_fiscal" required>
      </div>
      <div class="col-md-4">
        <label for="numero_nota_fiscal" class="form-label">Número da Nota Fiscal *</label>
        <input type="text" class="form-control" id="numero_nota_fiscal" name="numero_nota_fiscal" required>
      </div>
    </div>

    <!-- Seleção do fornecedor -->
    <div class="mb-3">
      <label for="fornecedor_id" class="form-label">Fornecedor *</label>
      <select class="form-select" id="fornecedor_id" name="fornecedor_id" required>
        <option value="">Selecione um fornecedor</option>
        {% for fornecedor in fornecedores %}
          <option value="{{ fornecedor.id }}">{{ fornecedor.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Itens da entrada -->
    <hr>
    <h5>Itens da Entrada</h5>
    <div id="itens-container">
      <!-- Primeiro item (modelo base) -->
      <div class="row mb-3 item-linha">
        <div class="col-md-4">
          <label class="form-label">Item *</label>
          <select class="form-select" name="item_id[]" required>
            <option value="">Selecione</option>
            {% for item in itens %}
              <option value="{{ item.id }}">{{ item.nome }} ({{ item.codigo_sap }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Quantidade *</label>
          <input type="number" class="form-control" name="quantidade[]" min="1" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valor Unitário *</label>
          <input type="number" class="form-control" name="valor_unitario[]" step="0.01" min="0" required>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="button" class="btn btn-danger btn-remover">Remover</button>
        </div>
      </div>
    </div>

    <!-- Botão para adicionar mais itens -->
    <div class="mb-3">
      <button type="button" class="btn btn-secondary" id="adicionar-item">Adicionar Item</button>
    </div>

    <!-- Botão de envio -->
    <button type="submit" class="btn btn-primary">Salvar Entrada</button>
    <a href="{{ url_for('entrada_bp.lista_entradas') }}" class="btn btn-outline-secondary">Cancelar</a>
  </form>
</div>

<!-- Script JavaScript para clonar itens -->
<script>
document.getElementById('adicionar-item').addEventListener('click', function() {
  const container = document.getElementById('itens-container');
  const novaLinha = container.querySelector('.item-linha').cloneNode(true);
  
  // Limpa os valores dos campos da nova linha
  novaLinha.querySelectorAll('input, select').forEach(el => el.value = '');
  container.appendChild(novaLinha);
});

// Remover linha de item
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-remover')) {
    const linha = e.target.closest('.item-linha');
    const container = document.getElementById('itens-container');
    if (container.querySelectorAll('.item-linha').length > 1) {
      linha.remove();
    }
  }
});
</script>
{% endblock %}