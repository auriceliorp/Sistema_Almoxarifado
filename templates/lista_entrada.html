{% extends 'base_simplificada.html' %}

{% block title %}Entradas de Materiais{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Cabeçalho -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h4 class="mb-0 flex-grow-1 text-center">Entradas de Materiais</h4>
    <a href="{{ url_for('entrada_bp.nova_entrada') }}" class="btn btn-success btn-lg">
      <i class="bi bi-plus-circle fs-4 me-1"></i> Nova Entrada
    </a>
  </div>

  <!-- Campo de busca com seletor -->
  <div class="row mb-3">
    <div class="col-md-6 offset-md-3">
      <form id="formFiltro" class="input-group">
        <select class="form-select" id="filtroTipo">
          <option value="3">Número Nota Fiscal</option>
          <option value="2">Data NF</option>
          <option value="1">Data Movimento</option>
          <option value="4">Fornecedor</option>
        </select>
        <input type="text" id="filtroBusca" class="form-control" placeholder="Buscar...">
        <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i></button>
      </form>
    </div>
  </div>

  <!-- Tabela -->
  <div class="table-responsive">
    <table id="tabela-entradas" class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Data Movimento</th>
          <th>Data Nota Fiscal</th>
          <th>Número Nota Fiscal</th>
          <th>Fornecedor</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for entrada in entradas %}
        <tr>
          <td>{{ entrada.id }}</td>
          <td>{{ entrada.data_movimento.strftime('%d/%m/%Y') }}</td>
          <td>{{ entrada.data_nota_fiscal.strftime('%d/%m/%Y') }}</td>
          <td>{{ entrada.numero_nota_fiscal }}</td>
          <td>{{ entrada.fornecedor.nome }}</td>
          <td>
            <a href="{{ url_for('entrada_bp.visualizar_entrada', entrada_id=entrada.id) }}"
               class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-eye"></i> Visualizar
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables e Plugins -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
  $(document).ready(function () {
    // Ativação da tabela
    const tabela = $('#tabela-entradas').DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json"
      },
      pageLength: 10,
      lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
      order: [[0, 'desc']]
    });

    // Máscaras
    $('#filtroBusca').on('input', function () {
      const tipo = $('#filtroTipo').val();
      if (tipo === '3') {
        $(this).mask('000.000.000');
      } else if (tipo === '1' || tipo === '2') {
        $(this).mask('00/00/0000');
      } else {
        $(this).unmask();
      }
    });

    // Filtro
    $('#formFiltro').on('submit', function (e) {
      e.preventDefault();
      const coluna = $('#filtroTipo').val();
      const valor = $('#filtroBusca').val();
      tabela.columns().search('');
      tabela.column(coluna).search(valor).draw();
    });
  });
</script>
{% endblock %}
