{% extends 'base_simplificada.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Nova Entrada de Material</h2>
  <form method="post">
    <!-- Dados principais da entrada -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="data_movimento" class="form-label">Data do Movimento *</label>
        <input type="date" class="form-control" id="data_movimento" name="data_movimento" required>
      </div>
      <div class="col-md-4">
        <label for="data_nota_fiscal" class="form-label">Data da Nota Fiscal *</label>
        <input type="date" class="form-control" id="data_nota_fiscal" name="data_nota_fiscal" required>
      </div>
      <div class="col-md-4">
        <label for="numero_nota_fiscal" class="form-label">Número da Nota Fiscal *</label>
        <input type="text" class="form-control" id="numero_nota_fiscal" name="numero_nota_fiscal" required>
      </div>
    </div>

    <!-- Fornecedor -->
    <div class="mb-4">
      <label for="fornecedor_id" class="form-label">Fornecedor *</label>
      <select class="form-select" id="fornecedor_id" name="fornecedor_id" required>
        <option value="">Selecione um fornecedor</option>
        {% for fornecedor in fornecedores %}
          <option value="{{ fornecedor.id }}">{{ fornecedor.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Itens da entrada -->
    <hr>
    <h5>Itens da Entrada</h5>
    <div id="itens-container">
      {% for i in range(5) %}
      <div class="row g-2 align-items-end item-linha mb-2">
        <div class="col-md-5">
          <label class="form-label">Item *</label>
          <select class="form-select" name="item_id[]" required>
            <option value="">Selecione</option>
            {% for item in itens %}
              <option value="{{ item.id }}">{{ item.nome }} ({{ item.codigo_sap }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Quantidade *</label>
          <input type="number" class="form-control" name="quantidade[]" min="1" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valor Unitário *</label>
          <input type="number" class="form-control" name="valor_unitario[]" step="0.01" min="0" required>
        </div>
        <div class="col-md-2 text-end">
          <button type="button" class="btn btn-sm btn-outline-danger btn-remover">Remover</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="mb-3">
      <button type="button" id="adicionar-item" class="btn btn-sm btn-outline-primary">+ Adicionar Item</button>
    </div>

    <!-- Botões finais -->
    <div class="mt-4">
      <button type="submit" class="btn btn-success">Salvar Entrada</button>
      <a href="{{ url_for('entrada_bp.lista_entradas') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>
  </form>
</div>

<!-- JavaScript para adicionar/remover linhas -->
<script>
document.getElementById('adicionar-item').addEventListener('click', function () {
  const container = document.getElementById('itens-container');
  const primeiraLinha = container.querySelector('.item-linha');
  const novaLinha = primeiraLinha.cloneNode(true);

  // Limpa os campos da nova linha
  novaLinha.querySelectorAll('input, select').forEach(el => el.value = '');
  container.appendChild(novaLinha);
});

document.addEventListener('click', function (e) {
  if (e.target.classList.contains('btn-remover')) {
    const linha = e.target.closest('.item-linha');
    const container = document.getElementById('itens-container');
    if (container.querySelectorAll('.item-linha').length > 1) {
      linha.remove();
    }
  }
});
</script>
{% endblock %}